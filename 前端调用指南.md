# 前端通过网关调用服务 01 接口指南

## 概述

本项目使用 Spring Cloud Gateway 作为 API 网关，前端应用通过网关来调用后端服务。这样做的好处包括：

- 统一入口点
- 负载均衡
- 安全控制
- 请求路由
- 跨域处理

## 网关配置

网关运行在端口 `9999`，配置了以下路由规则：

### 1. 服务 01 路由（推荐方式）

- **路径前缀**: `/server01/**`
- **目标服务**: `http://localhost:9801`
- **配置**: 会去掉路径前缀，添加响应头

### 2. API 路由（兼容方式）

- **路径前缀**: `/api/**`
- **目标服务**: `http://localhost:9801`（默认路由到服务 01）
- **配置**: 会去掉路径前缀，添加请求头

### 3. 服务 02 路由

- **路径前缀**: `/server02/**`
- **目标服务**: `http://localhost:9802`

## 前端调用方式

### 方式一：使用服务前缀路径（推荐）

#### 1. GET 请求示例

```javascript
// 调用服务01的hello接口
fetch("http://localhost:9999/server01/api/hello")
  .then((response) => response.json())
  .then((data) => console.log(data));

// 带参数的GET请求
fetch("http://localhost:9999/server01/api/hello?name=张三")
  .then((response) => response.json())
  .then((data) => console.log(data));

// 调用服务01的info接口
fetch("http://localhost:9999/server01/api/info")
  .then((response) => response.json())
  .then((data) => console.log(data));
```

#### 2. POST 请求示例

```javascript
// POST请求到服务01
fetch("http://localhost:9999/server01/api/data", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    message: "来自前端的数据",
    user: "测试用户",
    timestamp: new Date().toISOString(),
  }),
})
  .then((response) => response.json())
  .then((data) => console.log(data));
```

### 方式二：使用 API 路径

```javascript
// 这会被路由到服务01（根据网关配置）
fetch("http://localhost:9999/api/hello")
  .then((response) => response.json())
  .then((data) => console.log(data));

// 带参数
fetch("http://localhost:9999/api/hello?name=李四")
  .then((response) => response.json())
  .then((data) => console.log(data));
```

## 实际路由映射

当前端发起请求时，网关会进行如下路由：

| 前端请求                  | 实际转发到                     | 说明                        |
| ------------------------- | ------------------------------ | --------------------------- |
| `GET /server01/api/hello` | `GET localhost:9801/api/hello` | 推荐方式，明确指定服务      |
| `GET /api/hello`          | `GET localhost:9801/api/hello` | 兼容方式，默认路由到服务 01 |
| `GET /server02/api/hello` | `GET localhost:9802/api/hello` | 调用服务 02                 |
| `POST /server01/api/data` | `POST localhost:9801/api/data` | POST 请求示例               |

## jQuery/Ajax 示例

```javascript
// 使用jQuery
$.ajax({
  url: "http://localhost:9999/server01/api/hello",
  method: "GET",
  data: { name: "王五" },
  success: function (data) {
    console.log(data);
  },
  error: function (xhr, status, error) {
    console.error("请求失败:", error);
  },
});

// POST请求
$.ajax({
  url: "http://localhost:9999/server01/api/data",
  method: "POST",
  contentType: "application/json",
  data: JSON.stringify({
    message: "jQuery POST请求",
    user: "前端用户",
  }),
  success: function (data) {
    console.log(data);
  },
});
```

## Axios 示例

```javascript
// 使用Axios
import axios from "axios";

// GET请求
const response = await axios.get("http://localhost:9999/server01/api/hello", {
  params: { name: "赵六" },
});
console.log(response.data);

// POST请求
const postResponse = await axios.post("http://localhost:9999/server01/api/data", {
  message: "Axios POST请求",
  user: "前端用户",
  timestamp: new Date().toISOString(),
});
console.log(postResponse.data);
```

## 错误处理

```javascript
async function callApi() {
  try {
    const response = await fetch("http://localhost:9999/server01/api/hello");

    if (!response.ok) {
      throw new Error(`HTTP错误! status: ${response.status}`);
    }

    const data = await response.json();
    console.log("成功:", data);

    // 检查是否有网关添加的响应头
    console.log("网关响应头:", response.headers.get("X-Response-From"));
  } catch (error) {
    console.error("请求失败:", error);
  }
}
```

## 开发调试

### 1. 启动服务

```bash
# 启动网关
cd gateway && ./gradlew bootRun

# 启动服务01
cd server01 && ./gradlew bootRun

# 启动服务02
cd server02 && ./gradlew bootRun
```

### 2. 测试网关

```bash
# 测试网关信息
curl http://localhost:9999/gateway/info

# 测试服务01路由
curl http://localhost:9999/server01/api/hello

# 测试API路由
curl http://localhost:9999/api/hello
```

### 3. 查看网关日志

网关配置了 DEBUG 日志级别，可以查看请求路由的详细信息。

## 注意事项

1. **CORS 配置**: 网关已配置全局 CORS，支持跨域请求
2. **路径前缀**: 网关会自动去除路径前缀，如 `/server01/api/hello` 会转发为 `/api/hello`
3. **响应头**: 网关会添加 `X-Response-From: Gateway` 响应头
4. **请求头**: 通过 `/api/**` 路径的请求会添加 `X-Gateway-Request: true` 请求头
5. **服务发现**: 当前使用硬编码的服务地址，生产环境建议使用服务注册中心

## 生产环境建议

1. 使用服务注册中心（如 Eureka、Consul）
2. 配置负载均衡策略
3. 添加认证和授权
4. 配置熔断器和限流
5. 使用 HTTPS
6. 配置健康检查

## 相关文件

- 网关配置: `gateway/src/main/resources/application.yml`
- 网关控制器: `gateway/src/main/kotlin/com/demo/gateway/controller/GatewayController.kt`
- 服务 01 控制器: `server01/src/main/kotlin/com/demo/server01/controller/Server01Controller.kt`
- 前端示例: `web/index.html`
- API 测试: `web/rest.http`
